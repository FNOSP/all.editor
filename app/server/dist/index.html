<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <!-- <link rel="icon" type="image/svg+xml" href="/vite.svg" /> -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>æ–‡æœ¬ç¼–è¾‘å™¨</title>
  <script type="module" crossorigin src="/cgi/ThirdParty/all.editor/api.cgi?_api=read&path=/var/apps/all.editor/target/server/dist/assets/index-BXQQ80_P.js"></script>
  <link rel="stylesheet" crossorigin href="/cgi/ThirdParty/all.editor/api.cgi?_api=read&path=/var/apps/all.editor/target/server/dist/assets/index-LYhUP2Ly.css">
</head>

<body>
  <script>
    document.body.setAttribute('theme-mode', window.localStorage.getItem('fnos-theme-mode') || '');
  </script>
  <!-- æ–°å¸ƒå±€ï¼šä¸Šæ–¹é¢åŒ…å±‘å¯¼èˆª + ä¸‹æ–¹å·¦å³åˆ†æ  -->
  <div id="mainLayout" style="display: flex; flex-direction: column; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; overflow: hidden;">
    
    <!-- æœ€ä¸Šæ–¹é¢åŒ…å±‘å¯¼èˆª - å æ®å…¨å®½ -->
    <div class="w-full bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0" style="height: 35px;">
      <div class="px-6 py-4 h-full flex items-center" style="padding-top: 0px;">
        <div id="breadcrumb" class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400 overflow-x-auto">
        </div>
      </div>
    </div>

    <!-- ä¸‹æ–¹å·¦å³åˆ†æ åŒºåŸŸ -->
    <div class="flex-1 flex" style="overflow: hidden;">
      <!-- å·¦ä¾§æ–‡ä»¶ç®¡ç†å™¨ - å»æ‰æ ‡é¢˜å’Œé¢åŒ…å±‘ -->
      <div id="fileManagerSidebar" class="bg-white dark:bg-gray-800 shadow-xl border-r border-gray-200 dark:border-gray-700 flex flex-col" style="width: 256px; min-width: 256px; transition: width 0.3s ease;">
        <!-- æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="flex-1 overflow-auto p-4 space-y-2">
          <div id="fileList"></div>
        </div>
      </div>
      
      <!-- å³ä¾§æ–‡æœ¬ç¼–è¾‘å™¨ -->
      <div id="editorContainer" class="flex-1" style="overflow: hidden;">
        <div id="app" style="height: 100%; width: 100%; overflow: auto;"></div>
      </div>
    </div>
  </div>

  <script>
// æ–‡ä»¶ç®¡ç†å™¨åŠŸèƒ½ - è°ƒç”¨Node.js API
class FileManager {
  constructor() {
    this.currentPath = '/';
    this.fileList = [];
    this.config = null;
    // ä½¿ç”¨å‰ç«¯è®¿é—®çš„åè®®å’Œç«¯å£è°ƒç”¨APIï¼Œé€‚é…HTTPSå’Œæ— ç«¯å£åŸŸå
    const protocol = window.location.protocol; // http: æˆ– https:
    const host = window.location.hostname;     // åŸŸåï¼Œä¸åŒ…å«ç«¯å£
    const port = window.location.port;         // ç«¯å£å·ï¼ŒHTTPSé»˜è®¤443ï¼ŒHTTPé»˜è®¤80æ—¶ä¼šè¿”å›ç©ºå­—ç¬¦ä¸²
    
    // æ ¹æ®åè®®å’Œç«¯å£ç¡®å®šAPIç«¯å£
    let apiPort = port;
    if (!apiPort) {
      // æ— ç«¯å£å·æ—¶ï¼Œä½¿ç”¨åè®®å¯¹åº”çš„é»˜è®¤ç«¯å£
      apiPort = protocol === 'https:' ? '443' : '5666';
    }
    
    // æ„å»ºAPIåŸºç¡€URLï¼Œä½¿ç”¨ä¸å‰ç«¯ç›¸åŒçš„åè®®
    this.apiBaseUrl = `${protocol}//${host}:${apiPort}/cgi/ThirdParty/all.editor/server/api`;
    this.init();
  }

  async init() {
    this.bindEvents();
    await this.loadConfig();
    this.loadInitialPathFromURL();
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ŒåŠ¨æ€è°ƒæ•´æ–‡ä»¶ç®¡ç†å™¨å®½åº¦
    window.addEventListener('resize', () => {
      this.adjustFileManagerWidth();
    });
  }

  // åŠ è½½é…ç½®æ–‡ä»¶
  async loadConfig() {
    try {
      const configUrl = '/cgi/ThirdParty/all.editor/api.cgi?_api=read&path=/var/apps/all.editor/target/server/conf.json';
      const response = await fetch(configUrl);
      if (response.ok) {
        this.config = await response.json();
        console.log('âœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ:', this.config);
      } else {
        console.warn('âš ï¸ é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
        this.config = { FirstPath: ['/vol1/1000'] };
      }
    } catch (error) {
      console.warn('âš ï¸ é…ç½®æ–‡ä»¶è¯»å–é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
      this.config = { FirstPath: ['/vol1/1000'] };
    }
  }

  // è·å–é»˜è®¤è·¯å¾„åˆ—è¡¨
  getDefaultPaths() {
    return this.config?.FirstPath || ['/vol1/1000'];
  }

  // æ£€æŸ¥è·¯å¾„æ˜¯å¦ä¸ºé»˜è®¤è·¯å¾„
  isDefaultPath(path) {
    const defaultPaths = this.getDefaultPaths();
    return defaultPaths.includes(path);
  }

  // æ˜¾ç¤ºæ¬¢è¿ç•Œé¢
  showWelcomeScreen() {
    const editorContainer = document.getElementById('app');
    editorContainer.innerHTML = `
      <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; color: #333; text-align: center; position: relative; overflow: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;">
        
        <!-- ä¸»è¦å†…å®¹ -->
        <div style="max-width: 500px; padding: 60px 40px;">
          
          <!-- Logo åŒºåŸŸ -->
          <div style="margin-bottom: 20px;">
            <img src="/cgi/ThirdParty/all.editor/api.cgi?_api=read&path=/var/apps/all.editor/target/server/dist/assets/icon_96.png" alt="Editor Logo" style="width: 96px; height: 96px; object-fit: contain;">
          </div>
          
          <!-- æ ‡é¢˜ -->
          <h1 style="font-size: 2rem; font-weight: 600; margin-bottom: 10px; color: #212529; letter-spacing: 0.05em;">
            ä¸‡èƒ½ç¼–è¾‘å™¨
          </h1>
          
          <!-- å‰¯æ ‡é¢˜ -->
          <p style="font-size: 1rem; margin-bottom: 20px; color: #6c757d; line-height: 1.6; font-weight: 400;">
            é«˜æ•ˆçš„æ–‡æœ¬ç¼–è¾‘å·¥å…·
          </p>
          
          <!-- æç¤ºä¿¡æ¯ -->
          <div style="background: #fff; padding: 32px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); border: 1px solid #e9ecef; margin-bottom: 10px;">
            <p style="font-size: 0.95rem; margin: 0 0 12px 0; color: #495057; font-weight: 500;">
              è¯·ç‚¹å‡»å·¦ä¾§åˆ—è¡¨ä¸­çš„æ–‡ä»¶è¿›è¡Œç¼–è¾‘
            </p>
            <p style="font-size: 0.875rem; margin: 0; color: #6c757d;">
              æ”¯æŒæ–‡æœ¬ã€ä»£ç ã€å›¾ç‰‡ç­‰å¤šç§æ ¼å¼
            </p>
          </div>
          
          <!-- åŠŸèƒ½ç‰¹è‰² -->
          <div style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap;">
            <div style="background: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e9ecef;">
              <span style="font-size: 0.875rem; color: #495057; font-weight: 500;">è‡ªå¸¦å¯¼èˆª</span>
            </div>
            <div style="background: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e9ecef;">
              <span style="font-size: 0.875rem; color: #495057; font-weight: 500;">çµæ´»åˆ‡æ¢</span>
            </div>
            <div style="background: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); border: 1px solid #e9ecef;">
              <span style="font-size: 0.875rem; color: #495057; font-weight: 500;">è¯­æ³•é«˜äº®</span>
            </div>
          </div>
          
        </div>
      </div>
    `;
  }

  // ä»URLå‚æ•°ä¸­è¯»å–åˆå§‹è·¯å¾„ï¼ˆä»…å½±å“æ–‡ä»¶åˆ—è¡¨ï¼Œä¸å½±å“å³ä¾§ç¼–è¾‘å™¨ï¼‰
  loadInitialPathFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const pathParam = urlParams.get('path');
    
    if (pathParam) {
      console.log('ğŸ”— ä»URLè¯»å–è·¯å¾„:', pathParam);
      
      // è§£ç URL
      const decodedPath = decodeURIComponent(pathParam);
      console.log('ğŸ”— è§£ç åçš„è·¯å¾„:', decodedPath);
      
      // åˆ¤æ–­è·¯å¾„ç±»å‹
      if (this.isFilePath(decodedPath)) {
        // å¦‚æœæ˜¯æ–‡ä»¶ï¼Œæ˜¾ç¤ºå…¶æ‰€åœ¨ç›®å½•
        const directoryPath = this.getParentDirectory(decodedPath);
        console.log('ğŸ”— æ£€æµ‹åˆ°æ–‡ä»¶ï¼Œæ˜¾ç¤ºä¸Šçº§ç›®å½•:', directoryPath);
        
        // å…ˆæ£€æŸ¥è·¯å¾„æ˜¯å¦æœ‰æ•ˆï¼Œé¿å…"è¿™ä¸æ˜¯ä¸ªç›®å½•"é”™è¯¯
        if (this.isValidDirectoryPath(directoryPath)) {
          this.loadFileList(directoryPath);
        } else {
          console.log('âš ï¸ ä¸Šçº§ç›®å½•æ— æ•ˆï¼Œæ˜¾ç¤ºæ ¹ç›®å½•');
          this.loadFileList('/');
        }
        return;
      }
      
      // å¦‚æœè·¯å¾„æŒ‡å‘ç›®å½•ï¼Œç›´æ¥æ˜¾ç¤º
      console.log('ğŸ”— æ˜¾ç¤ºæŒ‡å®šç›®å½•:', decodedPath);
      this.loadFileList(decodedPath);
    } else {
      // æ²¡æœ‰pathå‚æ•°ï¼Œæ˜¾ç¤ºé»˜è®¤è·¯å¾„å’Œæ¬¢è¿ç•Œé¢
      console.log('ğŸ”— æ²¡æœ‰URLè·¯å¾„å‚æ•°ï¼Œæ˜¾ç¤ºé»˜è®¤è·¯å¾„å’Œæ¬¢è¿ç•Œé¢');
      this.loadFileList('/');
      this.showWelcomeScreen();
    }
  }

  // éªŒè¯ç›®å½•è·¯å¾„æ˜¯å¦æœ‰æ•ˆ
  isValidDirectoryPath(path) {
    // åŸºæœ¬çš„è·¯å¾„éªŒè¯
    if (!path || path === '/') {
      return true; // æ ¹ç›®å½•æ€»æ˜¯æœ‰æ•ˆçš„
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„è·¯å¾„
    const defaultPaths = this.getDefaultPaths();
    if (defaultPaths.includes(path)) {
      return true;
    }
    
    // ç§»é™¤å¼€å¤´çš„/
    const cleanPath = path.startsWith('/') ? path.substring(1) : path;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜ç¡®çš„ç›®å½•è·¯å¾„æ ¼å¼
    if (cleanPath.includes('/')) {
      // å¤šçº§è·¯å¾„ï¼Œéœ€è¦æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†
      const pathParts = cleanPath.split('/');
      return pathParts.length > 0 && pathParts.every(part => part.trim().length > 0);
    }
    
    // å•çº§è·¯å¾„ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥ç›®å½•
    const knownDirs = ['vol1', 'vol2'];
    return knownDirs.includes(cleanPath);
  }

  // è·å–ä¸Šä¸€çº§ç›®å½•è·¯å¾„
  getParentDirectory(filePath) {
    // ç§»é™¤å¼€å¤´çš„/
    const cleanPath = filePath.startsWith('/') ? filePath.substring(1) : filePath;
    
    // åˆ†å‰²è·¯å¾„
    const pathParts = cleanPath.split('/');
    
    // ç§»é™¤æœ€åä¸€éƒ¨åˆ†ï¼ˆæ–‡ä»¶åï¼‰
    pathParts.pop();
    
    // å¦‚æœè¿˜æœ‰è·¯å¾„ï¼Œè¿”å›å¸¦/çš„è·¯å¾„ï¼›å¦åˆ™è¿”å›/
    return pathParts.length > 0 ? '/' + pathParts.join('/') : '/';
  }

  // åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶è·¯å¾„
  isFilePath(filePath) {
    // ç§»é™¤å¼€å¤´çš„/
    const cleanPath = filePath.startsWith('/') ? filePath.substring(1) : filePath;
    
    // åˆ†å‰²è·¯å¾„å¹¶è·å–æœ€åä¸€éƒ¨åˆ†
    const pathParts = cleanPath.split('/');
    const lastPart = pathParts[pathParts.length - 1];
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶ï¼š
    // 1. æœ‰åç¼€åçš„æ–‡ä»¶
    // 2. ä¸åŒ…å«å¸¸è§çš„ç›®å½•åï¼ˆä½†ä¸æ˜¯æ–‡ä»¶åï¼‰
    // 3. æ˜ç¡®åˆ¤æ–­çš„ç‰¹å®šæ ¼å¼
    if (lastPart.includes('.')) {
      // æœ‰åç¼€åï¼Œåº”è¯¥æ˜¯æ–‡ä»¶
      return true;
    }
    
    // å¯¹äºæ— åç¼€åçš„ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­
    // ä½†è¿™é‡Œæˆ‘ä»¬ä¿å®ˆåœ°è®¤ä¸ºæ— åç¼€åå¯èƒ½æ˜¯æ–‡ä»¶ï¼Œé¿å…å¼ºåˆ¶å½“ä½œç›®å½•
    // åªæœ‰æ˜ç¡®çš„ç›®å½•åæ‰å½“ä½œç›®å½•å¤„ç†
    const knownDirs = ['vol1', 'vol2', 'documents', 'downloads', 'music', 'videos'];
    if (knownDirs.includes(lastPart)) {
      return false; // æ˜ç¡®æ˜¯ç›®å½•å
    }
    
    // å…¶ä»–æƒ…å†µä¿å®ˆåœ°å½“ä½œæ–‡ä»¶å¤„ç†
    return true;
  }

  bindEvents() {
    // æ— éœ€ç»‘å®šå…³é—­æŒ‰é’®å’Œæ¨¡æ€æ¡†äº‹ä»¶ï¼ˆå·²æ”¹ä¸ºå›ºå®šå¸ƒå±€ï¼‰
  }

  // æ¸…é™¤æ¬¢è¿ç•Œé¢
  clearWelcomeScreen() {
    const editorContainer = document.getElementById('app');
    if (editorContainer.innerHTML.includes('æ¬¢è¿ä½¿ç”¨ä¸‡èƒ½ç¼–è¾‘å™¨')) {
      editorContainer.innerHTML = '';
    }
  }

  // è¯»å–ç›®å½•å†…å®¹ - è°ƒç”¨Node.js API
  async loadFileList(path = '/') {
    try {
      this.currentPath = path;
      this.updateBreadcrumb();

      // é»˜è®¤æ˜¾ç¤ºé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„è·¯å¾„
      if (path === '/') {
        const defaultPaths = this.getDefaultPaths();
        this.fileList = [];
        
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰é»˜è®¤è·¯å¾„çš„å†…å®¹
        const fetchPromises = defaultPaths.map(async (defaultPath) => {
          try {
            const cleanPath = defaultPath.substring(1); // å»æ‰å¼€å¤´çš„/
            const apiUrl = `${this.apiBaseUrl}?_api=list&path=${defaultPath}`;
            console.log('ğŸ“¡ APIåœ°å€:', apiUrl);

            const response = await fetch(apiUrl);
            const data = await response.json();

            if (data.code === 200 || data.success === true) {
              const files = data.data?.files || data.files || [];
              // ä¸ºæ¯ä¸ªæ–‡ä»¶æ·»åŠ åŸå§‹è·¯å¾„ä¿¡æ¯
              return files.map(file => ({
                ...file,
                path: defaultPath + '/' + file.name,
                originalPath: defaultPath,
                displayPath: defaultPath + '/' + file.name
              }));
            } else {
              const errorMsg = data.msg || data.error || 'æœªçŸ¥é”™è¯¯';
              return [{
                name: `[${defaultPath} - é”™è¯¯: ${errorMsg}]`,
                type: 'folder',
                disabled: true,
                originalPath: defaultPath,
                displayPath: defaultPath + '/[error]'
              }];
            }
          } catch (error) {
            console.error(`ğŸ’¥ åŠ è½½è·¯å¾„ ${defaultPath} å¤±è´¥:`, error);
            return [{
              name: `[${defaultPath} - åŠ è½½å¤±è´¥]`,
              type: 'folder',
              disabled: true,
              originalPath: defaultPath,
              displayPath: defaultPath + '/[error]'
            }];
          }
        });
        
        const results = await Promise.all(fetchPromises);
        this.fileList = results.flat();
        
        console.log('ğŸ“ åŠ è½½æ ¹ç›®å½• (é»˜è®¤è·¯å¾„):', this.fileList);
        this.renderFileList();
        return;
      }

      // è§£æè·¯å¾„
      const cleanPath = path.substring(1); // å»æ‰å¼€å¤´çš„/
      
      console.log('ğŸ” è°ƒç”¨APIè¯»å–ç›®å½•:', cleanPath);
      
      // è°ƒç”¨Node.js API
      const apiUrl = `${this.apiBaseUrl}?_api=list&path=/${cleanPath}`;
      console.log('ğŸ“¡ APIåœ°å€:', apiUrl);
      
      const response = await fetch(apiUrl);
      const data = await response.json();
      
      // å…¼å®¹ä¸¤ç§å“åº”æ ¼å¼ï¼š{code:200,msg:...,data:{files:[...]}} æˆ– {success:true,files:[...]}
      if (data.code === 200 || data.success === true) {
        console.log('âœ… APIå“åº”æˆåŠŸ:', data);
        // ä¼˜å…ˆä½¿ç”¨æ–°çš„data.filesæ ¼å¼ï¼Œå›é€€åˆ°æ—§çš„filesæ ¼å¼
        this.fileList = data.data?.files || data.files || [];
      } else {
        // æå–é”™è¯¯ä¿¡æ¯ï¼Œå…¼å®¹ä¸¤ç§æ ¼å¼
        const errorMsg = data.msg || data.error || 'æœªçŸ¥é”™è¯¯';
        console.error('âŒ APIè¿”å›é”™è¯¯:', errorMsg);
        this.fileList = [{
          name: `[é”™è¯¯: ${errorMsg}]`,
          type: 'folder',
          disabled: true
        }];
      }
      
      // æŒ‰æ–‡ä»¶å¤¹åœ¨å‰ï¼Œæ–‡ä»¶åœ¨åæ’åº
      this.fileList.sort((a, b) => {
        if (a.type === 'folder' && b.type !== 'folder') return -1;
        if (a.type !== 'folder' && b.type === 'folder') return 1;
        return a.name.localeCompare(b.name);
      });
      
      console.log('âœ… å¤„ç†å®Œæˆ:', this.fileList);
      this.renderFileList();

      // å»¶è¿Ÿè°ƒæ•´å®½åº¦ï¼Œç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
      setTimeout(() => {
        this.adjustFileManagerWidth();
      }, 100);

    } catch (error) {
      console.error('ğŸ’¥ åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
      // é”™è¯¯æ—¶æ˜¾ç¤ºé…ç½®ä¸­çš„é»˜è®¤è·¯å¾„
      const defaultPaths = this.getDefaultPaths();
      this.fileList = defaultPaths.map(defaultPath => ({
        name: `[${defaultPath} - åŠ è½½å¤±è´¥]`,
        type: 'folder',
        disabled: true
      }));
      this.renderFileList();

      // å»¶è¿Ÿè°ƒæ•´å®½åº¦
      setTimeout(() => {
        this.adjustFileManagerWidth();
      }, 100);
    }
  }

updateBreadcrumb() {
  const breadcrumb = document.getElementById('breadcrumb');
  breadcrumb.innerHTML = '';
  
  // è®¾ç½®é¢åŒ…å±‘å®¹å™¨ä¸ºç›¸å¯¹å®šä½å’Œå¼¹æ€§å¸ƒå±€
  breadcrumb.style.position = 'relative';
  breadcrumb.style.display = 'flex';
  breadcrumb.style.alignItems = 'center';
  breadcrumb.style.flexWrap = 'wrap';
  breadcrumb.style.gap = '4px';
  breadcrumb.style.zIndex = '10';
  breadcrumb.style.minHeight = '32px'; // ç¡®ä¿æœ‰è¶³å¤Ÿé«˜åº¦
  breadcrumb.style.width = '90%'

  // åˆ›å»ºé¢åŒ…å±‘å†…å®¹å®¹å™¨
  const breadcrumbContent = document.createElement('div');
  breadcrumbContent.style.display = 'flex';
  breadcrumbContent.style.alignItems = 'center';
  breadcrumbContent.style.flexWrap = 'wrap';
  breadcrumbContent.style.gap = '4px';
  breadcrumbContent.style.zIndex = '11'; // é«˜äºè¾“å…¥æ¡†
  breadcrumbContent.style.position = 'relative';

  // "æˆ‘çš„æ–‡ä»¶"æŒ‰é’®
  const rootSpan = document.createElement('span');
  rootSpan.className = 'cursor-pointer hover:text-blue-600 font-medium mr-2';
  rootSpan.textContent = 'æˆ‘çš„æ–‡ä»¶';
  rootSpan.onclick = () => this.goToRoot();
  breadcrumbContent.appendChild(rootSpan);

  // æ˜¾ç¤ºè·¯å¾„å±‚çº§é¢åŒ…å±‘
  if (this.currentPath !== '/') {
    const pathParts = this.currentPath.split('/').filter(part => part);

    pathParts.forEach((part, index) => {
      // åˆ†éš”ç¬¦
      const separator = document.createElement('span');
      separator.className = 'text-xs text-gray-400 mx-1';
      separator.textContent = '/';
      breadcrumbContent.appendChild(separator);

      // ç›®å½•é“¾æ¥
      const dirSpan = document.createElement('span');
      dirSpan.className = 'cursor-pointer hover:text-blue-600';
      dirSpan.textContent = part;
      // è®¡ç®—åˆ°å½“å‰éƒ¨åˆ†çš„è·¯å¾„
      const breadcrumbPath = '/' + pathParts.slice(0, index + 1).join('/');
      dirSpan.onclick = (e) => {
        e.stopPropagation();
        console.log('ç‚¹å‡»é¢åŒ…å±‘å¯¼èˆª:', breadcrumbPath);
        this.navigate(breadcrumbPath);
      };
      breadcrumbContent.appendChild(dirSpan);
    });
  }

  // å¯ç¼–è¾‘çš„è·¯å¾„è¾“å…¥æ¡†
  const input = document.createElement('input');
  input.type = 'text';
  input.id = 'breadcrumbInput';
  input.value = this.currentPath === '/' ? '/' : this.currentPath;
  input.className = 'flex-1 max-w-sm px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:border-blue-500 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white';
  input.placeholder = 'ç‚¹å‡»æ­¤å¤„ç¼–è¾‘è·¯å¾„';
  
  // è¾“å…¥æ¡†æ ·å¼ - ç»å¯¹å®šä½åœ¨åº•å±‚
  input.style.position = 'absolute';
  input.style.left = '0';
  input.style.top = '0';
  input.style.width = '100%';
  input.style.zIndex = '1'; // ä½äºé¢åŒ…å±‘å†…å®¹
  input.style.opacity = '0'; // é»˜è®¤éšè—
  
  // äº‹ä»¶ç›‘å¬
  input.addEventListener('focus', (e) => {
    e.stopPropagation();
    this.enterEditMode(input, breadcrumbContent);
  });

  input.addEventListener('blur', () => {
    setTimeout(() => {
      if (!input.classList.contains('editing')) {
        this.exitEditMode(input, breadcrumbContent);
      }
    }, 100);
  });

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      this.navigateToPath(input.value);
      this.exitEditMode(input, breadcrumbContent);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      this.exitEditMode(input, breadcrumbContent);
    }
  });

  // æ·»åŠ åˆ°é¢åŒ…å±‘å®¹å™¨
  breadcrumb.appendChild(input);
  breadcrumb.appendChild(breadcrumbContent);
}

// è¿›å…¥ç¼–è¾‘æ¨¡å¼
enterEditMode(input, breadcrumbContent) {
  input.classList.add('editing');

  // åªéšè—è·¯å¾„é¢åŒ…å±‘éƒ¨åˆ†ï¼Œä¿ç•™"æˆ‘çš„æ–‡ä»¶"æŒ‰é’®
  const pathElements = breadcrumbContent.querySelectorAll('span:not(.font-medium)');
  pathElements.forEach(el => {
    el.style.opacity = '0'; // éšè—è·¯å¾„åˆ†éš”ç¬¦å’Œç›®å½•é“¾æ¥
  });

  input.style.opacity = '1'; // æ˜¾ç¤ºè¾“å…¥æ¡†

  // è®¡ç®—"æˆ‘çš„æ–‡ä»¶"æŒ‰é’®çš„å®½åº¦ï¼Œè®©è¾“å…¥æ¡†æ˜¾ç¤ºåœ¨å…¶å³è¾¹
  const rootSpan = breadcrumbContent.querySelector('span.font-medium');
  if (rootSpan) {
    const rootSpanWidth = rootSpan.offsetWidth + 16; // åŠ ä¸Šä¸€äº›é—´è·
    input.style.left = `${rootSpanWidth}px`;
    input.style.width = `calc(100% - ${rootSpanWidth}px)`;
  } else {
    input.style.left = '0';
    input.style.width = '100%';
  }

  input.focus();
  input.select();
}

// é€€å‡ºç¼–è¾‘æ¨¡å¼
exitEditMode(input, breadcrumbContent) {
  input.classList.remove('editing');
  breadcrumbContent.style.opacity = '1'; // æ˜¾ç¤ºé¢åŒ…å±‘å†…å®¹
  input.style.opacity = '0'; // éšè—è¾“å…¥æ¡†
  input.blur();
}

// å¯¼èˆªåˆ°æŒ‡å®šè·¯å¾„
navigateToPath(path) {
  // æ¸…ç†è·¯å¾„
  let cleanPath = path.trim();
  if (!cleanPath) {
    console.warn('âš ï¸ è·¯å¾„ä¸ºç©º');
    return;
  }
    
    // ç¡®ä¿è·¯å¾„ä»¥/å¼€å¤´
    if (!cleanPath.startsWith('/')) {
      cleanPath = '/' + cleanPath;
    }
    
    // éªŒè¯è·¯å¾„
    if (!this.isValidDirectoryPath(cleanPath) && cleanPath !== '/') {
      alert(`è·¯å¾„æ— æ•ˆ: ${cleanPath}`);
      return;
    }
    
    console.log('ğŸ”— å¯¼èˆªåˆ°è·¯å¾„:', cleanPath);
    this.navigate(cleanPath);
  }

  renderFileList() {
    const fileListEl = document.getElementById('fileList');
    fileListEl.innerHTML = '';

    this.fileList.forEach(file => {
      const div = document.createElement('div');
      const isDisabled = file.disabled;
      div.className = `flex items-center space-x-3 p-3 rounded-lg cursor-pointer transition-colors ${
        isDisabled
          ? 'opacity-50 cursor-not-allowed'
          : 'hover:bg-gray-100 dark:hover:bg-gray-700'
      }`;

      const icon = file.type === 'folder' ? 'ğŸ“' : 'ğŸ“„';
      
      div.innerHTML = `
        <span class="text-lg flex-shrink-0">${icon}</span>
        <div class="flex-1 min-w-0">
          <div class="font-medium break-all">${file.name}</div>
        </div>
      `;

      if (!isDisabled) {
        div.onclick = () => {
          if (file.type === 'folder') {
            // ä½¿ç”¨æ–‡ä»¶çš„æ˜¾ç¤ºè·¯å¾„è¿›è¡Œå¯¼èˆª
            this.navigate(file.displayPath || file.path);
          } else {
            this.openFile(file);
          }
        };
      }

      fileListEl.appendChild(div);
    });

    // åŠ¨æ€è°ƒæ•´æ–‡ä»¶ç®¡ç†å™¨å®½åº¦
    this.adjustFileManagerWidth();
  }

  // åŠ¨æ€è°ƒæ•´æ–‡ä»¶ç®¡ç†å™¨å®½åº¦
  adjustFileManagerWidth() {
    const fileManagerSidebar = document.getElementById('fileManagerSidebar');
    const fileListEl = document.getElementById('fileList');
    
    // è®¡ç®—æœ€é•¿çš„æ–‡ä»¶åæ‰€éœ€çš„å®½åº¦
    let maxWidth = 256; // é»˜è®¤æœ€å°å®½åº¦
    
    const fileItems = fileListEl.querySelectorAll('div > div > div');
    fileItems.forEach(item => {
      if (item.classList.contains('font-medium')) {
        const tempSpan = document.createElement('span');
        tempSpan.style.position = 'absolute';
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.whiteSpace = 'nowrap';
        tempSpan.style.fontSize = window.getComputedStyle(item).fontSize;
        tempSpan.style.fontWeight = window.getComputedStyle(item).fontWeight;
        tempSpan.textContent = item.textContent;
        document.body.appendChild(tempSpan);
        
        const textWidth = tempSpan.offsetWidth;
        document.body.removeChild(tempSpan);
        
        // è®¡ç®—æ€»å®½åº¦ï¼šå›¾æ ‡ + æ–‡ä»¶å + é—´è· + å†…è¾¹è·
        const iconWidth = 24; // å›¾æ ‡å®½åº¦
        const padding = 48; // å·¦å³å†…è¾¹è·
        const spacing = 12; // å…ƒç´ é—´è·
        const totalWidth = textWidth + iconWidth + padding + spacing;
        
        maxWidth = Math.max(maxWidth, totalWidth);
      }
    });

    // é™åˆ¶æœ€å¤§å®½åº¦ä¸ºé¡µé¢å®½åº¦çš„50%
    const maxAllowedWidth = window.innerWidth * 0.5;
    const finalWidth = Math.min(maxWidth, maxAllowedWidth);
    
    // è®¾ç½®æ–‡ä»¶ç®¡ç†å™¨å®½åº¦
    fileManagerSidebar.style.width = `${finalWidth}px`;
    fileManagerSidebar.style.minWidth = `${finalWidth}px`;
  }

  // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
  formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let size = bytes;
    let unitIndex = 0;
    while (size >= 1024 && unitIndex < units.length - 1) {
      size /= 1024;
      unitIndex++;
    }
    return `${size.toFixed(1)} ${units[unitIndex]}`;
  }

  navigate(path) {
    this.loadFileList(path);
    // å¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼Œæ¸…é™¤æ¬¢è¿ç•Œé¢
    if (path !== '/') {
      this.clearWelcomeScreen();
    }
  }

  goToRoot() {
    this.loadFileList('/');
    this.showWelcomeScreen(); // ç¡®ä¿æ˜¾ç¤ºæ¬¢è¿ç•Œé¢
    this.updateBreadcrumb(); // é‡æ–°æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
  }

  // åˆ¤æ–­æ˜¯å¦ä¸ºå›¾ç‰‡æ–‡ä»¶
  isImageFile(fileName) {
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.ico'];
    const lowerFileName = fileName.toLowerCase();
    return imageExtensions.some(ext => lowerFileName.endsWith(ext));
  }

  // ç‚¹å‡»æ–‡ä»¶æ—¶å¤„ç†
  async openFile(file) {
    try {
      // ä½¿ç”¨æ–‡ä»¶çš„åŸå§‹è·¯å¾„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨å½“å‰è·¯å¾„
      const filePath = file.originalPath || file.path || this.currentPath + '/' + file.name;
      console.log('ğŸ“„ ç‚¹å‡»æ–‡ä»¶:', filePath);
      
      // æ¸…é™¤æ¬¢è¿ç•Œé¢
      this.clearWelcomeScreen();
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡æ–‡ä»¶
      if (this.isImageFile(file.name)) {
        this.displayImage({...file, path: filePath});
      } else {
        // è·³è½¬åˆ°æ–‡æœ¬ç¼–è¾‘å™¨URL
        this.redirectToTextEditor(filePath);
      }
      
    } catch (error) {
      console.error('ğŸ’¥ æ‰“å¼€æ–‡ä»¶å¤±è´¥:', error);
    }
  }

  // æ˜¾ç¤ºå›¾ç‰‡
  displayImage(file) {
    const editorContainer = document.getElementById('app');
    
    // ç§»é™¤å¼€å¤´çš„æ–œæ ï¼Œæ„å»ºAPIè·¯å¾„
    const cleanPath = file.path.startsWith('/') ? file.path.substring(1) : file.path;
    
    // ä½¿ç”¨æ–‡ä»¶ç®¡ç†å™¨çš„å›¾ç‰‡API
    const imageUrl = `${this.apiBaseUrl}?_api=image&path=/${cleanPath}`;
    
    console.log('ğŸ–¼ï¸ æ˜¾ç¤ºå›¾ç‰‡:', imageUrl);
    console.log('ğŸ“„ æ–‡ä»¶ä¿¡æ¯:', file);
    
    // åˆ›å»ºå›¾ç‰‡æ˜¾ç¤ºHTML - å æ®å…¨éƒ¨ç©ºé—´
    editorContainer.innerHTML = `
      <div style="width: 100%; height: 100%; display: flex; flex-direction: column; background-color: #f5f5f5; overflow: auto; position: relative;">
        
        <!-- å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ - å æ®å…¨éƒ¨ç©ºé—´ -->
        <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px;">
          <img src="${imageUrl}" alt="${file.name}"
               style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px; box-shadow: 0 2px 12px rgba(0,0,0,0.1);"
               onerror="this.style.display='none'; this.parentElement.innerHTML='<p style=\\'color: red; font-size: 16px; text-align: center;\\'>å›¾ç‰‡åŠ è½½å¤±è´¥<br/>URL: ${imageUrl}</p>'">
        </div>
      </div>
    `;
  }

  // è·³è½¬åˆ°æ–‡æœ¬ç¼–è¾‘å™¨
  redirectToTextEditor(filePath) {
    // è·å–å½“å‰åœ°å€ä¿¡æ¯
    const protocol = window.location.protocol; // http: æˆ– https:
    const hostname = window.location.hostname;
    const port = window.location.port;
      // æ„å»ºåŸºç¡€URL
    let baseUrl;
    if (port) {
      baseUrl = `${protocol}//${hostname}:${port}`;
    } else {
      baseUrl = `${protocol}//${hostname}`;
    }
          
          
    // æ„å»ºç›®æ ‡URL
    const targetUrl = `${baseUrl}/cgi/ThirdParty/all.editor/index.cgi?path=${encodeURIComponent(filePath)}`;
    
    console.log('ğŸ”— è·³è½¬åˆ°æ–‡æœ¬ç¼–è¾‘å™¨:', targetUrl);
    
    // å®é™…è·³è½¬
    window.location.href = targetUrl;
  }
}

// åˆå§‹åŒ–æ–‡ä»¶ç®¡ç†å™¨
const fileManager = new FileManager();

// æ·»åŠ å…¨å±€æ–¹æ³•ä»¥ä¾¿é¢åŒ…å±‘å¯¼èˆªä½¿ç”¨
window.fileManager = fileManager;

  </script>
</body>

</html>
